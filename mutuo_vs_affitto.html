<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mutuo vs Affitto - Analisi Matematica</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #34495e;
            font-size: 0.9em;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .tooltip {
            font-size: 0.8em;
            color: #7f8c8d;
            margin-top: 3px;
            font-style: italic;
        }

        .calculate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .results {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            border: 2px solid #667eea;
        }

        .results h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .option-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .option-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .cost-item:last-child {
            border-bottom: none;
            font-weight: 600;
            color: #2c3e50;
            border-top: 2px solid #667eea;
            padding-top: 12px;
        }

        .winner {
            text-align: center;
            padding: 20px;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 600;
            margin-top: 20px;
        }

        .analysis {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border-left: 5px solid #667eea;
        }

        .analysis h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .analysis ul {
            margin-left: 20px;
        }

        .analysis li {
            margin-bottom: 8px;
            color: #34495e;
        }

        .risk-factors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .risk-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }

        .risk-card h4 {
            color: #e74c3c;
            margin-bottom: 8px;
        }

        .risk-card p {
            font-size: 0.9em;
            color: #34495e;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .input-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè† Mutuo vs Affitto - Analisi Matematica</h1>
        
        <div class="input-grid">
            <!-- Dati Immobile -->
            <div class="section">
                <h2>üèòÔ∏è Dati Immobile</h2>
                <div class="form-group">
                    <label for="prezzoAcquisto">Prezzo d'acquisto (‚Ç¨)</label>
                    <input type="number" id="prezzoAcquisto" value="200000">
                </div>
                
                <div class="form-group">
                    <label for="speseRistrutturazione">Spese ristrutturazione/restauro (‚Ç¨)</label>
                    <input type="number" id="speseRistrutturazione" value="15000">
                    <div class="tooltip">Lavori iniziali: bagno, cucina, impianti, pitture</div>
                </div>
                
                <div class="form-group">
                    <label for="imu">IMU annuale (‚Ç¨)</label>
                    <input type="number" id="imu" value="1200">
                </div>
                
                <div class="form-group">
                    <label for="manutenzione">Manutenzione annuale (% valore)</label>
                    <input type="number" id="manutenzione" value="0.8" step="0.1">
                </div>
                
                <div class="form-group">
                    <label for="assicurazione">Assicurazione annuale (‚Ç¨)</label>
                    <input type="number" id="assicurazione" value="300">
                </div>
                
                <div class="form-group">
                    <label for="orizzonteTempo">Orizzonte temporale (anni)</label>
                    <input type="number" id="orizzonteTempo" value="15">
                    <div class="tooltip">Per quanto tempo prevedi di rimanere</div>
                </div>
                
                <div class="form-group">
                    <label for="valorizzazione">Valorizzazione annua immobile (%)</label>
                    <input type="number" id="valorizzazione" value="2" step="0.1">
                    <div class="tooltip">Quanto aumenta il valore dell'immobile ogni anno</div>
                </div>
                
                <div class="form-group">
                    <label for="liquidita">Facilit√† di rivendita</label>
                    <select id="liquidita">
                        <option value="1">Molto difficile (periferia, mercato stagnante)</option>
                        <option value="0.9">Difficile (zona poco richiesta)</option>
                        <option value="0.8">Normale (mercato standard)</option>
                        <option value="0.7">Buona (zona richiesta)</option>
                        <option value="0.6" selected>Ottima (centro citt√†, alta domanda)</option>
                    </select>
                    <div class="tooltip">Influenza i costi di vendita e i tempi</div>
                </div>
            </div>

            <!-- Dati Mutuo -->
            <div class="section">
                <h2>üè¶ Dati Mutuo</h2>
                <div class="form-group">
                    <label for="anticipo">Anticipo (%)</label>
                    <input type="number" id="anticipo" value="20">
                </div>
                
                <div class="form-group">
                    <label for="tassoInteresse">Tasso interesse annuo (%)</label>
                    <input type="number" id="tassoInteresse" value="3.5" step="0.1">
                </div>
                
                <div class="form-group">
                    <label for="durataMutuo">Durata mutuo (anni)</label>
                    <input type="number" id="durataMutuo" value="25">
                </div>
                
                <div class="form-group">
                    <label for="speseNotarili">Spese notarili e agenzia (‚Ç¨)</label>
                    <input type="number" id="speseNotarili" value="8000">
                    <div class="tooltip">Notaio, agenzia, tasse di registro</div>
                </div>
            </div>

            <!-- Dati Affitto -->
            <div class="section">
                <h2>üè† Dati Affitto</h2>
                <div class="form-group">
                    <label for="canoneAffitto">Canone mensile (‚Ç¨)</label>
                    <input type="number" id="canoneAffitto" value="650">
                    <div class="tooltip">Affitto dello stesso immobile o equivalente</div>
                </div>
                
                <div class="form-group">
                    <label for="aumentoCanone">Aumento canone annuo (%)</label>
                    <input type="number" id="aumentoCanone" value="2" step="0.1">
                    <div class="tooltip">Inflazione + rivalutazioni</div>
                </div>
                
                <div class="form-group">
                    <label for="cauzione">Cauzione (mensilit√†)</label>
                    <input type="number" id="cauzione" value="3">
                </div>
                
                <div class="form-group">
                    <label for="speseCondominiali">Spese condominiali mensili (‚Ç¨)</label>
                    <input type="number" id="speseCondominiali" value="150">
                </div>
                
                <div class="form-group">
                    <label for="costiTrasloco">Costi trasloco ogni X anni (‚Ç¨)</label>
                    <input type="number" id="costiTrasloco" value="2000">
                </div>
                
                <div class="form-group">
                    <label for="frequenzaTrasloco">Frequenza trasloco (anni)</label>
                    <input type="number" id="frequenzaTrasloco" value="5">
                </div>
            </div>

            <!-- Parametri Finanziari -->
            <div class="section">
                <h2>üìä Parametri Finanziari</h2>
                <div class="form-group">
                    <label for="inflazione">Inflazione annua (%)</label>
                    <input type="number" id="inflazione" value="2" step="0.1">
                </div>
                
                <div class="form-group">
                    <label for="tassazione">Tassazione capital gains (%)</label>
                    <input type="number" id="tassazione" value="26">
                    <div class="tooltip">Tasse sulla plusvalenza immobiliare</div>
                </div>
                
                <div class="form-group">
                    <label for="rischioMercato">Rischio mercato immobiliare</label>
                    <select id="rischioMercato">
                        <option value="0">Molto basso (mercato stabile)</option>
                        <option value="0.05">Basso (lieve volatilit√†)</option>
                        <option value="0.1" selected>Medio (volatilit√† normale)</option>
                        <option value="0.15">Alto (mercato volatile)</option>
                        <option value="0.2">Molto alto (crisi possibile)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="includiInvestimenti">
                        <input type="checkbox" id="includiInvestimenti" style="width: auto; margin-right: 10px;">
                        Considera investimenti alternativi
                    </label>
                    <div class="tooltip">Se attivato, considera il rendimento dell'anticipo investito altrove</div>
                </div>
                
                <div class="form-group" id="groupTassoSconto" style="display: none;">
                    <label for="tassoSconto">Tasso di sconto annuo (%)</label>
                    <input type="number" id="tassoSconto" value="4" step="0.1">
                    <div class="tooltip">Rendimento alternativo dei tuoi investimenti</div>
                </div>
            </div>
        </div>

        <button class="calculate-btn" onclick="calcolaConfronto()">
            üßÆ Calcola Confronto Dettagliato
        </button>

        <div id="results" class="results" style="display: none;">
            <h2>üìà Risultati dell'Analisi</h2>
            <div class="comparison-grid">
                <div class="option-card">
                    <h3>üè† Acquisto con Mutuo</h3>
                    <div id="costiMutuo"></div>
                </div>
                <div class="option-card">
                    <h3>üè† Affitto</h3>
                    <div id="costiAffitto"></div>
                </div>
            </div>
            
            <div id="vincitore" class="winner"></div>
            
            <!-- Insights Personalizzati -->
            <div id="insightsPersonalizzati" style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 15px; color: white;">
                <h3 style="margin: 0 0 15px 0; display: flex; align-items: center;"><span style="margin-right: 10px;">üí°</span>Insights Personalizzati</h3>
                <div id="suggerimenti" style="display: grid; gap: 10px;"></div>
            </div>
            
            <div class="analysis">
                <h3>üìã Analisi Dettagliata</h3>
                <div id="analisiDettagliata"></div>
                
                <!-- Analisi di Sensibilit√† -->
                <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 12px; border-left: 5px solid #667eea;">
                    <h3 style="color: #2c3e50; margin: 0 0 15px 0; display: flex; align-items: center;">
                        <span style="margin-right: 10px;">‚öñÔ∏è</span>Analisi di Sensibilit√†
                    </h3>
                    <div id="analisiSensibilita" style="display: grid; gap: 10px;"></div>
                </div>
                
                <h3>üìä Andamento nel Tempo</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <h4 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">üí∞ Costi Cumulativi</h4>
                        <canvas id="graficoAcquisto" width="400" height="300"></canvas>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <h4 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">üè† Patrimonio vs Spese</h4>
                        <canvas id="graficoPatrimonio" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <h3>‚ö†Ô∏è Fattori di Rischio</h3>
                <div class="risk-factors" id="fattoriRischio"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // Gestione visibilit√† campo investimenti
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('includiInvestimenti').addEventListener('change', function() {
                const groupTasso = document.getElementById('groupTassoSconto');
                groupTasso.style.display = this.checked ? 'block' : 'none';
            });
        },

        function generaInsights(dati, differenza) {
            const suggerimenti = [];
            const isAcquistoConveniente = differenza < 0;
            const risparmio = Math.abs(differenza);
            
            // Insight principale
            if (risparmio > 10000) {
                const azione = isAcquistoConveniente ? 'risparmiare' : 'spendere';
                const valoreFormattato = formatCurrency(risparmio);
                suggerimenti.push({
                    icona: "üí∞",
                    testo: "Potresti " + azione + " <strong>" + valoreFormattato + "</strong> nei prossimi " + dati.orizzonteTempo + " anni"
                });
            }
            
            // Suggerimenti temporali
            if (dati.orizzonteTempo < 7) {
                suggerimenti.push({
                    icona: "‚è∞",
                    testo: "Con un orizzonte cos√¨ breve, considera i costi di transazione. L'affitto offre pi√π flessibilit√†."
                });
            } else if (dati.orizzonteTempo > 15) {
                suggerimenti.push({
                    icona: "üè†",
                    testo: "Su lungo termine, la propriet√† immobiliare tende a essere pi√π vantaggiosa per l'accumulo patrimoniale."
                });
            }
            
            // Insight sui tassi
            const tassoAttuale = parseFloat(document.getElementById('tassoInteresse').value) / 100;
            if (tassoAttuale > 0.045) {
                suggerimenti.push({
                    icona: "üìà",
                    testo: "I tassi attuali sono alti. Considera di aspettare un eventuale calo o negoziare condizioni migliori."
                });
            }
            
            // Insight sulla valorizzazione
            const yieldAffitto = (dati.canoneAffitto * 12 / dati.prezzoAcquisto) * 100;
            if (yieldAffitto < 3) {
                suggerimenti.push({
                    icona: "‚ö°",
                    testo: "Lo yield affitto √® solo " + yieldAffitto.toFixed(1) + "%. Questo immobile potrebbe essere sopravvalutato per l'investimento."
                });
            } else if (yieldAffitto > 6) {
                suggerimenti.push({
                    icona: "üéØ",
                    testo: "Yield affitto eccellente (" + yieldAffitto.toFixed(1) + "%)! L'acquisto sembra un buon affare."
                });
            }
            
            // Previsione futura
            const valoreTraDieci = dati.prezzoAcquisto * Math.pow(1 + dati.valorizzazione, 10);
            if (isAcquistoConveniente) {
                suggerimenti.push({
                    icona: "üîÆ",
                    testo: "Tra 10 anni il tuo patrimonio immobiliare potrebbe valere circa <strong>" + formatCurrency(valoreTraDieci) + "</strong>"
                });
            }
            
            // Render suggerimenti
            const container = document.getElementById('suggerimenti');
            let htmlContent = '';
            for (let i = 0; i < suggerimenti.length; i++) {
                const s = suggerimenti[i];
                htmlContent += '<div style="display: flex; align-items: flex-start; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px; margin-bottom: 8px;">';
                htmlContent += '<span style="font-size: 1.2em; margin-right: 12px;">' + s.icona + '</span>';
                htmlContent += '<span style="flex: 1; line-height: 1.4;">' + s.testo + '</span>';
                htmlContent += '</div>';
            }
            container.innerHTML = htmlContent;
        },

        function generaAnalisiSensibilita(dati) {
            const analisi = [];
            
            // Sensibilit√† ai tassi
            const tassoAttuale = parseFloat(document.getElementById('tassoInteresse').value) / 100;
            const nuovoTasso = tassoAttuale + 0.015; // +1.5%
            const importoMutuo = dati.prezzoAcquisto * 0.8; // Assumendo 20% anticipo
            const nuovaRata = calcolaRataMutuo(importoMutuo, nuovoTasso, 25);
            const aumentoRata = (nuovaRata - dati.rataMensile) * 12 * dati.orizzonteTempo;
            
            analisi.push({
                scenario: "Se i tassi aumentano al " + (nuovoTasso * 100).toFixed(1) + "%",
                impatto: "Costi aggiuntivi: " + formatCurrency(aumentoRata),
                colore: "#e74c3c"
            });
            
            // Sensibilit√† alla valorizzazione
            if (dati.valorizzazione < 0.01) {
                const perdita = dati.prezzoAcquisto * dati.valorizzazione * dati.orizzonteTempo;
                analisi.push({
                    scenario: "Se l'immobile non si valorizza (0%)",
                    impatto: "Perdi " + formatCurrency(Math.abs(perdita)) + " di guadagni potenziali",
                    colore: "#e74c3c"
                });
            } else {
                const valorizzazioneDoppia = dati.prezzoAcquisto * Math.pow(1 + dati.valorizzazione * 2, dati.orizzonteTempo);
                const valorizzazioneNormale = dati.prezzoAcquisto * Math.pow(1 + dati.valorizzazione, dati.orizzonteTempo);
                const guadagnoExtra = valorizzazioneDoppia - valorizzazioneNormale;
                analisi.push({
                    scenario: "Se la valorizzazione raddoppia (" + (dati.valorizzazione * 200).toFixed(1) + "%)",
                    impatto: "Guadagni extra: " + formatCurrency(guadagnoExtra),
                    colore: "#27ae60"
                });
            }
            
            // Sensibilit√† ai costi affitto
            const affittoPiu20 = dati.canoneAffitto * 1.2;
            const costoExtraAffitto = (affittoPiu20 - dati.canoneAffitto) * 12 * dati.orizzonteTempo;
            analisi.push({
                scenario: "Se l'affitto costa +20% (" + formatCurrency(affittoPiu20) + "/mese)",
                impatto: "Costi extra: " + formatCurrency(costoExtraAffitto),
                colore: "#f39c12"
            });
            
            // Render analisi
            const container = document.getElementById('analisiSensibilita');
            let htmlContent = '';
            for (let i = 0; i < analisi.length; i++) {
                const a = analisi[i];
                htmlContent += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid ' + a.colore + ';">';
                htmlContent += '<span style="font-weight: 500; color: #2c3e50;">' + a.scenario + '</span>';
                htmlContent += '<span style="font-weight: 600; color: ' + a.colore + ';">' + a.impatto + '</span>';
                htmlContent += '</div>';
            }
            container.innerHTML = htmlContent;
        }
        );

        function calcolaConfronto() {
            // Raccolta dati
            const prezzoAcquisto = parseFloat(document.getElementById('prezzoAcquisto').value);
            const speseRistrutturazione = parseFloat(document.getElementById('speseRistrutturazione').value);
            const imu = parseFloat(document.getElementById('imu').value);
            const manutenzione = parseFloat(document.getElementById('manutenzione').value) / 100;
            const assicurazione = parseFloat(document.getElementById('assicurazione').value);
            const orizzonteTempo = parseInt(document.getElementById('orizzonteTempo').value);
            const valorizzazione = parseFloat(document.getElementById('valorizzazione').value) / 100;
            const liquidita = parseFloat(document.getElementById('liquidita').value);
            
            const anticipo = parseFloat(document.getElementById('anticipo').value) / 100;
            const tassoInteresse = parseFloat(document.getElementById('tassoInteresse').value) / 100;
            const durataMutuo = parseInt(document.getElementById('durataMutuo').value);
            const speseNotarili = parseFloat(document.getElementById('speseNotarili').value);
            
            const canoneAffitto = parseFloat(document.getElementById('canoneAffitto').value);
            const aumentoCanone = parseFloat(document.getElementById('aumentoCanone').value) / 100;
            const cauzione = parseFloat(document.getElementById('cauzione').value);
            const speseCondominiali = parseFloat(document.getElementById('speseCondominiali').value);
            const costiTrasloco = parseFloat(document.getElementById('costiTrasloco').value);
            const frequenzaTrasloco = parseInt(document.getElementById('frequenzaTrasloco').value);
            
            const inflazione = parseFloat(document.getElementById('inflazione').value) / 100;
            const tassazione = parseFloat(document.getElementById('tassazione').value) / 100;
            const rischioMercato = parseFloat(document.getElementById('rischioMercato').value);
            const includiInvestimenti = document.getElementById('includiInvestimenti').checked;
            const tassoSconto = includiInvestimenti ? parseFloat(document.getElementById('tassoSconto').value) / 100 : 0;

            // Calcoli Mutuo
            const importoMutuo = prezzoAcquisto * (1 - anticipo);
            const importoAnticipo = prezzoAcquisto * anticipo;
            const rataMensile = calcolaRataMutuo(importoMutuo, tassoInteresse, durataMutuo);
            
            let costiMutuoTotali = 0;
            let costiAffittoTotali = 0;
            
            // Costi iniziali mutuo
            costiMutuoTotali += importoAnticipo + speseNotarili + speseRistrutturazione;
            
            // Costi annuali mutuo
            let valoreImmobile = prezzoAcquisto;
            
            for (let anno = 1; anno <= orizzonteTempo; anno++) {
                let costiAnno = (rataMensile * 12) + imu + (valoreImmobile * manutenzione) + assicurazione;
                
                // Attualizzazione solo se consideriamo investimenti
                if (includiInvestimenti) {
                    costiMutuoTotali += costiAnno / Math.pow(1 + tassoSconto, anno);
                } else {
                    costiMutuoTotali += costiAnno;
                }
                valoreImmobile *= (1 + valorizzazione);
            }
            
            // Valore residuo immobile - CALCOLO CORRETTO
            const costiVendita = valoreImmobile * liquidita * 0.05;
            const plusvalenza = Math.max(0, valoreImmobile - prezzoAcquisto - costiVendita);
            const tassePlusvalenza = plusvalenza * tassazione;
            const valoreNettoVendita = valoreImmobile - costiVendita - tassePlusvalenza;
            
            // CORREZIONE: Non sottrarre tutto il valore, ma calcola il beneficio netto
            let beneficioPatrimoniale = 0;
            if (includiInvestimenti) {
                // Solo se consideri investimenti, calcola il valore attuale del patrimonio finale
                const valoreAttualePatrimonio = valoreNettoVendita / Math.pow(1 + tassoSconto, orizzonteTempo);
                // Sottrai solo il beneficio rispetto ad altri investimenti
                beneficioPatrimoniale = valoreAttualePatrimonio - (prezzoAcquisto * Math.pow(1 + tassoSconto, orizzonteTempo));
                costiMutuoTotali -= Math.max(0, beneficioPatrimoniale); // Solo se c'√® un beneficio reale
            } else {
                // Senza investimenti, considera solo il fatto che hai un asset al posto di affitti pagati
                // Ma non sottrai tutto perch√© non √® liquidit√† immediata
                beneficioPatrimoniale = (valoreNettoVendita - prezzoAcquisto) * 0.7; // Sconto per illiquidit√†
                costiMutuoTotali -= Math.max(0, beneficioPatrimoniale);
            }
            
            // Calcoli Affitto
            costiAffittoTotali += canoneAffitto * cauzione; // Cauzione iniziale
            
            let canoneCorrente = canoneAffitto;
            
            for (let anno = 1; anno <= orizzonteTempo; anno++) {
                let costiAnno = (canoneCorrente * 12) + (speseCondominiali * 12);
                
                // Aggiungi costi trasloco
                if (anno % frequenzaTrasloco === 0) {
                    costiAnno += costiTrasloco;
                }
                
                if (includiInvestimenti) {
                    costiAffittoTotali += costiAnno / Math.pow(1 + tassoSconto, anno);
                } else {
                    costiAffittoTotali += costiAnno;
                }
                canoneCorrente *= (1 + aumentoCanone);
            }
            
            // Solo se consideriamo investimenti, aggiungi il costo opportunit√† dell'anticipo
            if (includiInvestimenti) {
                const rendimentoAlternativo = importoAnticipo * Math.pow(1 + tassoSconto, orizzonteTempo);
                const costoOpportunita = rendimentoAlternativo - importoAnticipo;
                costiAffittoTotali += costoOpportunita;
            }
            
            // Aggiustamento per rischio
            costiMutuoTotali *= (1 + rischioMercato);
            
            // Visualizzazione risultati
            mostraRisultati(costiMutuoTotali, costiAffittoTotali, {
                prezzoAcquisto, canoneAffitto, orizzonteTempo, valorizzazione,
                importoAnticipo, rataMensile, valoreNettoVendita, liquidita,
                rischioMercato, tassoSconto, speseRistrutturazione, speseNotarili,
                imu, manutenzione, assicurazione, aumentoCanone, speseCondominiali,
                includiInvestimenti
            });
        }

        function calcolaRataMutuo(importo, tasso, durata) {
            const tassoMensile = tasso / 12;
            const numRate = durata * 12;
            return importo * (tassoMensile * Math.pow(1 + tassoMensile, numRate)) / 
                   (Math.pow(1 + tassoMensile, numRate) - 1);
        }

        function mostraRisultati(costiMutuo, costiAffitto, dati) {
            const differenza = costiMutuo - costiAffitto;
            const percentualeDiff = Math.abs(differenza / Math.min(costiMutuo, costiAffitto) * 100);
            
            // Assicuriamoci che i costi siano sempre positivi per la visualizzazione
            const costiMutuoDisplay = Math.abs(costiMutuo);
            const costiAffittoDisplay = Math.abs(costiAffitto);
            
            document.getElementById('costiMutuo').innerHTML = 
                '<div class="cost-item"><span>Anticipo:</span><span>' + formatCurrency(dati.importoAnticipo) + '</span></div>' +
                '<div class="cost-item"><span>Spese notarili + agenzia:</span><span>' + formatCurrency(dati.speseNotarili) + '</span></div>' +
                '<div class="cost-item"><span>Ristrutturazione iniziale:</span><span>' + formatCurrency(dati.speseRistrutturazione) + '</span></div>' +
                '<div class="cost-item"><span>Rate + spese ' + dati.orizzonteTempo + ' anni:</span><span>' + formatCurrency(dati.rataMensile * 12 * dati.orizzonteTempo) + '</span></div>' +
                '<div class="cost-item"><span>Valore finale stimato:</span><span>' + formatCurrency(dati.valoreNettoVendita) + '</span></div>' +
                '<div class="cost-item"><span><strong>Costo totale netto:</strong></span><span><strong>' + formatCurrency(costiMutuoDisplay) + '</strong></span></div>';
            
            const includiInv = document.getElementById('includiInvestimenti').checked;
            let investimentiInfo = '';
            if (includiInv) {
                const rendimentoAlternativo = dati.importoAnticipo * Math.pow(1 + dati.tassoSconto, dati.orizzonteTempo);
                investimentiInfo = '<div class="cost-item"><span>Mancato guadagno investimenti:</span><span>' + formatCurrency(rendimentoAlternativo - dati.importoAnticipo) + '</span></div>';
            }
            
            document.getElementById('costiAffitto').innerHTML = 
                '<div class="cost-item"><span>Canone iniziale:</span><span>' + formatCurrency(dati.canoneAffitto) + '/mese</span></div>' +
                '<div class="cost-item"><span>Cauzione:</span><span>' + formatCurrency(dati.canoneAffitto * 3) + '</span></div>' +
                '<div class="cost-item"><span>Totale affitti ' + dati.orizzonteTempo + ' anni:</span><span>' + formatCurrency(costiAffittoDisplay - (includiInv ? (dati.importoAnticipo * Math.pow(1 + dati.tassoSconto, dati.orizzonteTempo) - dati.importoAnticipo) : 0)) + '</span></div>' +
                investimentiInfo +
                '<div class="cost-item"><span><strong>Costo totale:</strong></span><span><strong>' + formatCurrency(costiAffittoDisplay) + '</strong></span></div>';
            
            const vincitore = document.getElementById('vincitore');
            if (differenza < 0) {
                vincitore.innerHTML = 'üèÜ ACQUISTO CONVIENE<br>Risparmi: ' + formatCurrency(Math.abs(differenza)) + ' (' + percentualeDiff.toFixed(1) + '%)';
                vincitore.style.background = 'linear-gradient(45deg, #2ecc71, #27ae60)';
            } else {
                vincitore.innerHTML = 'üèÜ AFFITTO CONVIENE<br>Risparmi: ' + formatCurrency(Math.abs(differenza)) + ' (' + percentualeDiff.toFixed(1) + '%)';
                vincitore.style.background = 'linear-gradient(45deg, #3498db, #2980b9)';
            }
            
            const yieldAffitto = (dati.canoneAffitto * 12 / dati.prezzoAcquisto) * 100;
            const breakEven = differenza < 0 ? 'Acquisto pi√π conveniente' : 'Affitto pi√π conveniente';
            
            const analisi = document.getElementById('analisiDettagliata');
            analisi.innerHTML = '<ul>' +
                '<li><strong>Rendimento immobiliare annuo:</strong> ' + (dati.valorizzazione * 100).toFixed(1) + '%</li>' +
                '<li><strong>Yield affitto:</strong> ' + yieldAffitto.toFixed(1) + '%</li>' +
                '<li><strong>Risultato:</strong> ' + breakEven + '</li>' +
                '</ul>';
            
            // Fattori di rischio
            
            const fattoriRischio = document.getElementById('fattoriRischio');
            fattoriRischio.innerHTML = '<div class="risk-card"><h4>Rischio Mercato</h4><p>Volatilit√† prezzi immobiliari</p></div>';
            
            document.getElementById('results').style.display = 'block';
            
            // Genera insights e analisi
            if (typeof generaInsights === 'function') {
                generaInsights(dati, differenza);
            }
            if (typeof generaAnalisiSensibilita === 'function') {
                generaAnalisiSensibilita(dati);
            }
            
            // Genera i grafici
            if (typeof generaGrafici === 'function') {
                generaGrafici(dati);
            }
        }

        function generaGrafici(dati) {
            // Calcola i dati per i grafici anno per anno
            const anni = [];
            const costiAcquistoAnnuali = [];
            const costiAffittoAnnuali = [];
            const valoreImmobileAnnuale = [];
            const patrimonioNettoAnnuale = [];
            let costoAcquistoCumulativo = dati.importoAnticipo + dati.speseNotarili + dati.speseRistrutturazione;
            let costoAffittoCumulativo = dati.canoneAffitto * 3; // cauzione
            let valoreImmobile = dati.prezzoAcquisto;
            let canoneCorrente = dati.canoneAffitto;
            
            for (let anno = 0; anno <= dati.orizzonteTempo; anno++) {
                anni.push(anno);
                
                if (anno === 0) {
                    costiAcquistoAnnuali.push(costoAcquistoCumulativo);
                    costiAffittoAnnuali.push(costoAffittoCumulativo);
                    valoreImmobileAnnuale.push(valoreImmobile);
                    patrimonioNettoAnnuale.push(valoreImmobile - costoAcquistoCumulativo);
                } else {
                    // Costi annuali acquisto
                    const costiAnnoAcquisto = (dati.rataMensile * 12) + dati.imu + (valoreImmobile * dati.manutenzione) + dati.assicurazione;
                    costoAcquistoCumulativo += costiAnnoAcquisto;
                    
                    // Costi annuali affitto
                    const costiAnnoAffitto = (canoneCorrente * 12) + (dati.speseCondominiali * 12);
                    costoAffittoCumulativo += costiAnnoAffitto;
                    
                    // Aggiorna valore immobile
                    valoreImmobile *= (1 + dati.valorizzazione);
                    canoneCorrente *= (1 + dati.aumentoCanone);
                    
                    costiAcquistoAnnuali.push(costoAcquistoCumulativo);
                    costiAffittoAnnuali.push(costoAffittoCumulativo);
                    valoreImmobileAnnuale.push(valoreImmobile);
                    patrimonioNettoAnnuale.push(valoreImmobile - costoAcquistoCumulativo);
                }
            }
            
            // Grafico 1: Costi Cumulativi
            const ctx1 = document.getElementById('graficoAcquisto').getContext('2d');
            new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: anni,
                    datasets: [{
                        label: 'Costi Acquisto',
                        data: costiAcquistoAnnuali,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Costi Affitto',
                        data: costiAffittoAnnuali,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç¨' + value.toLocaleString('it-IT');
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Anni'
                            }
                        }
                    },
                    interaction: {
                        intersect: false
                    }
                }
            });
            
            // Grafico 2: Patrimonio vs Spese
            const ctx2 = document.getElementById('graficoPatrimonio').getContext('2d');
            new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: anni,
                    datasets: [{
                        label: 'Valore Immobile',
                        data: valoreImmobileAnnuale,
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        tension: 0.4,
                        fill: false
                    }, {
                        label: 'Patrimonio Netto',
                        data: patrimonioNettoAnnuale,
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        tension: 0.4,
                        fill: false
                    }, {
                        label: 'Spese Affitto Cumulative',
                        data: costiAffittoAnnuali,
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç¨' + value.toLocaleString('it-IT');
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Anni'
                            }
                        }
                    },
                    interaction: {
                        intersect: false
                    }
                }
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
    </script>
</body>
</html>